/* $Workfile: BI_LINE_PSB_INC.sql $
*  $Revision: 4 $
*  $Archive: /DRTRNT_or_P/PeopleSoft Billing and RCPO - 115/Tables/OTR_BI_LINE_PSB/BI_LINE_PSB_INC.sql $
*  $Author: Laiqi $
*  $Date: 12/31/11 4:25p $
*
* Description: This table is loaded from Peoplesoft databases FSTRNx.  It is an incremental load that does a truncate/insert
*     on the current partition (NO Archive) which holds the curren year plus two previous years of data.  This was implemented to improve
*     load performance.  An extra check is performed during the month of January to move the oldest year into the non-current
*     (YES Archive) partition.
*
* Destination table = DRTRNx.DBO.OTR_BI_LINE_PSB
* Source table = FSTRNX.SYSADM.PS_BI_LINE
* 
* Revisions: 
* 
*   change Date    Description 
*   ------------------    ------------------ 
*   06/16/2009     Neeraja V,Cognizant - Self running script. TTP #7917.
*   03/29/2010     Chinnathambi S, Cognizant - Add new columns for ED to DR migration - TTP 7578
*   07/08/2010     Andrew Wiersma,Trane - Added our index manip code- TTP 7578
*   06/17/2011     Nithin Raj,Cognizant -  Modified to incremental load to reload present year and past two year data -TTP 10014
*   11/23/2011     Bhavani,Cognizant - Modified the script to move data from non-archive partition into archive partition if more than 3years in
*                                                     january month-TTP 10014
*************************************************************************************************************/ 

set timing on
set pause off
set feedback on
set echo on

spool bi_line_psb_inc.log  
whenever sqlerror exit failure;

prompt User and Database Connected To:
select user, name from v$database;

prompt inserting data into OTR_BI_LINE_PSB
DECLARE
V_START_DATE DATE:=ADD_MONTHS (TRUNC (SYSDATE, 'YYYY'), -24);

BEGIN
/* Perform this check all of Jan to avoid losing data if the module is not run for some reason.
  Checks the data warehouse table to see if there is any data in the No Archive partition that is older than the 3 years that
  will be loaded daily.  If there is, it is moved to the Yes Archive partition before the truncate so that it will not be lost.  The only
  time this can occur is in January of a new year. */
IF TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'MMDD')) BETWEEN  0101 AND 0131 THEN
insert /*+ APPEND */ into OTR_BI_LINE_PSB
(BUSINESS_UNIT,
INVOICE,
LINE_SEQ_NUM,
INVOICE_LINE,
ORIGINAL_INVOICE,
ORIGINAL_LINE_SEQ,
NEXT_ADJ_INVOICE,
NEXT_ADJ_LINE_SEQ,
PRIOR_ADJ_INVOICE,
PRIOR_ADJ_LINE_SEQ,
LATEST_INVOICE,
LATEST_LINE_SEQ,
BILL_SOURCE_ID,
SUBCUST_QUAL1,
SUBCUST_QUAL2,
ADJ_LINE_TYPE,
ADJUSTED_FLAG,
LINE_TYPE,
BI_CURRENCY_CD,
BASE_CURRENCY,
CURRENCY_CD_XEU,
CHARGE_FROM_DT,
IDENTIFIER,
DESCR,
UNIT_OF_MEASURE,
QTY,
UNIT_AMT,
PRICE_RECALC_FLG,
TAX_CD,
TAX_EXEMPT_CERT,
TAX_EXEMPT_FLG,
GROSS_EXTENDED_AMT,
NET_EXTENDED_AMT,
ORIG_AMOUNT,
GROSS_EXTENDED_BSE,
NET_EXTENDED_BSE,
GROSS_EXTENDED_XEU,
NET_EXTENDED_XEU,
TAX_AMT,
TAX_AMT_BSE,
TAX_AMT_XEU,
TAX_PCT,
FINAL_TAX_FLG,
VAT_BASIS_AMT,
VAT_BASIS_AMT_BSE,
VAT_BASIS_AMT_XEU,
VAT_AMT,
VAT_AMT_BSE,
VAT_AMT_XEU,
VAT_TRANS_AMT,
VAT_TRANS_AMT_BSE,
VAT_TXN_TYPE_CD,
TAX_CD_VAT,
TAX_CD_VAT_PCT,
VAT_APPLICABILITY,
PROD_GRP_SETID,
VAT_PRODUCT_GROUP,
PRODUCT_KIT_ID,
VAT_DISTRIB_STATUS,
TAX_VAT_FLG,
REV_RECOG_BASIS,
DEFERRED_STATUS,
TOT_LINE_DST_PCT,
TOT_LINE_DFR_PCT,
TOT_LINE_UAR_PCT,
TOT_LINE_DST_AMT,
TOT_LINE_DFR_AMT,
TOT_LINE_UAR_AMT,
TOT_LINE_DST_BSE,
TOT_LINE_DFR_BSE,
TOT_LINE_UAR_BSE,
TOT_LINE_DST_XEU,
TOT_LINE_DFR_XEU,
TOT_LINE_UAR_XEU,
TOT_DISCOUNT_AMT,
TOT_SURCHARGE_AMT,
TOT_DISCOUNT_BSE,
TOT_SURCHARGE_BSE,
TOT_DISCOUNT_XEU,
TOT_SURCHARGE_XEU,
LINE_DST_SEQ_NUM,
LINE_DFR_SEQ_NUM,
LINE_UAR_SEQ_NUM,
LAST_NOTE_SEQ_NUM,
ENTRY_TYPE,
ENTRY_REASON,
PC_DISTRIB_STATUS,
PO_REF,
PO_LINE,
BUSINESS_UNIT_CA,
CONTRACT_NUM,
CONTRACT_DT,
CONTRACT_TYPE,
BILL_PLAN_ID,
BPLAN_LN_NBR,
EVENT_OCCURRENCE,
XREF_SEQ_NUM,
CONTRACT_PPD_SEQ,
BUSINESS_UNIT_OM,
ORDER_NO,
ORDER_DATE,
ORDER_INT_LINE_NO,
SCHED_LINE_NBR,
BUSINESS_UNIT_RMA,
RMA_ID,
RMA_LINE_NBR,
PRODUCT_ID,
DIST_CFG_FLAG,
FREIGHT_TERMS,
BILL_OF_LADING,
SHIP_TO_CUST_ID,
SHIP_TO_ADDR_NUM,
SHIP_ID,
SHIP_TYPE_ID,
SHIP_FROM_BU,
SHIP_DATE,
SEQUENCE_NBR,
SOLD_TO_CUST_ID,
SOLD_TO_ADDR_NUM,
BUSINESS_UNIT_PC,
RESOURCE_ID,
PROJECT_ID,
ANALYSIS_TYPE,
RESOURCE_TYPE,
RESOURCE_CATEGORY,
RESOURCE_SUB_CAT,
ACTIVITY_ID,
ACTIVITY_TYPE,
SYSTEM_SOURCE,
EMPLID,
SSN,
EMPL_RCD,
SERVICE_CUST_ID,
SERVICE_ADDR_NUM,
START_DT,
ACCUMULATE,
ERROR_STATUS_BI,
CONTRACT_LINE_NUM,
BUSINESS_UNIT_TO,
IST_TXN_FLG,
IST_DISTRIB_STATUS,
INVENTORY_ITEM,
FISCAL_REGIME,
NATURE_OF_TXN1,
NATURE_OF_TXN2,
IDENTIFIER_TBL,
PACKSLIP_NO,
PPRC_PROMO_CD,
LIST_PRICE,
USER_AMT1,
USER_AMT2,
USER_AMT1_BSE,
USER_AMT2_BSE,
USER_AMT1_XEU,
USER_AMT2_XEU,
USER_DT1,
USER1,
USER2,
USER3,
USER4,
USER5,
USER6,
USER7,
USER8,
USER9,
PROCESS_INSTANCE,
ADD_DTTM,
LAST_UPDATE_DTTM,
LAST_MAINT_OPRID,
ACCRUE_DT,
ASSET_ID,
BI_TAX_TIMING,
BUSINESS_UNIT_AMTO,
BUSINESS_UNIT_RF,
CHARGE_TO_DT,
COST_TYPE,
COUNTRY_LOC_BUYER,
COUNTRY_LOC_SELLER,
COUNTRY_SHIP_FROM,
COUNTRY_SHIP_TO,
COUNTRY_VAT_BILLFR,
COUNTRY_VAT_BILLTO,
COUNTRY_VAT_PERFRM,
COUNTRY_VAT_SUPPLY,
DEFER_DT,
END_DT,
ENTRY_EVENT,
EXD_APPL_FLG,
EXD_ASSESS_VALUE,
EXD_CONVERSION_RT,
EXD_CUST_CATG_CD,
EXD_INVOICE_LINE,
EXD_INVOICE_NO,
EXD_ITM_CATG_CD,
EXD_TAX_AMT,
EXD_TAX_AMT_BSE,
EXD_TAX_AMT_RPT,
EXD_TAX_RATE_CD,
EXD_TAX_RATE_SRC,
EXD_UOM,
EXD_USE_AV_FLG,
EXS_CURRENCY_RPTG,
EXS_DFLTS_APPLIED,
EXS_SERV_TAX_FLG,
EXS_TAX_TXN_TYPE,
FORM_DISTRIB_STAT,
INV_ITEM_ID,
LANG_DESCR_OVR,
MAX_TAX_FLG,
MERCH_TYPE,
ORG_CODE,
ORG_SETID,
ORG_TAX_LOC_CD,
ORIG_QTY,
PHYSICAL_NATURE,
PROFILE_ID,
QTY_BASE,
RT_EFFDT,
SHIP_TIME,
SOURCE_REF_KEY,
SOURCE_REF_NO,
SOURCE_REF_TYPE,
SO_ID,
STATE_LOC_BUYER,
STATE_LOC_SELLER,
STATE_SHIP_FROM,
STATE_SHIP_TO,
STATE_VAT_DEFAULT,
STATE_VAT_PERFRM,
STATE_VAT_SUPPLY,
STX_APPL_FLG,
STX_CUST_CATG_CD,
STX_FORM_CD,
STX_ITM_CATG_CD,
STX_TAX_AMT,
STX_TAX_AMT_BSE,
STX_TAX_AMT_RPT,
STX_TAX_AUTH_CD,
STX_TAX_RATE_CD,
STX_TAX_RATE_SRC,
USER_DT2,
VAT_DFLT_DONE_FLG,
VAT_SERVICE_TYPE,
VAT_SVC_SUPPLY_FLG,
VAT_TREATMENT,
ED_CREATE_DATE,
ED_CREATE_ID,
ED_SOURCE_ARCHIVE_IND,
ARCHIVE_FLAG
)
SELECT
BUSINESS_UNIT,
INVOICE,
LINE_SEQ_NUM,
INVOICE_LINE,
ORIGINAL_INVOICE,
ORIGINAL_LINE_SEQ,
NEXT_ADJ_INVOICE,
NEXT_ADJ_LINE_SEQ,
PRIOR_ADJ_INVOICE,
PRIOR_ADJ_LINE_SEQ,
LATEST_INVOICE,
LATEST_LINE_SEQ,
BILL_SOURCE_ID,
SUBCUST_QUAL1,
SUBCUST_QUAL2,
ADJ_LINE_TYPE,
ADJUSTED_FLAG,
LINE_TYPE,
BI_CURRENCY_CD,
BASE_CURRENCY,
CURRENCY_CD_XEU,
CHARGE_FROM_DT,
IDENTIFIER,
DESCR,
UNIT_OF_MEASURE,
QTY,
UNIT_AMT,
PRICE_RECALC_FLG,
TAX_CD,
TAX_EXEMPT_CERT,
TAX_EXEMPT_FLG,
GROSS_EXTENDED_AMT,
NET_EXTENDED_AMT,
ORIG_AMOUNT,
GROSS_EXTENDED_BSE,
NET_EXTENDED_BSE,
GROSS_EXTENDED_XEU,
NET_EXTENDED_XEU,
TAX_AMT,
TAX_AMT_BSE,
TAX_AMT_XEU,
TAX_PCT,
FINAL_TAX_FLG,
VAT_BASIS_AMT,
VAT_BASIS_AMT_BSE,
VAT_BASIS_AMT_XEU,
VAT_AMT,
VAT_AMT_BSE,
VAT_AMT_XEU,
VAT_TRANS_AMT,
VAT_TRANS_AMT_BSE,
VAT_TXN_TYPE_CD,
TAX_CD_VAT,
TAX_CD_VAT_PCT,
VAT_APPLICABILITY,
PROD_GRP_SETID,
VAT_PRODUCT_GROUP,
PRODUCT_KIT_ID,
VAT_DISTRIB_STATUS,
TAX_VAT_FLG,
REV_RECOG_BASIS,
DEFERRED_STATUS,
TOT_LINE_DST_PCT,
TOT_LINE_DFR_PCT,
TOT_LINE_UAR_PCT,
TOT_LINE_DST_AMT,
TOT_LINE_DFR_AMT,
TOT_LINE_UAR_AMT,
TOT_LINE_DST_BSE,
TOT_LINE_DFR_BSE,
TOT_LINE_UAR_BSE,
TOT_LINE_DST_XEU,
TOT_LINE_DFR_XEU,
TOT_LINE_UAR_XEU,
TOT_DISCOUNT_AMT,
TOT_SURCHARGE_AMT,
TOT_DISCOUNT_BSE,
TOT_SURCHARGE_BSE,
TOT_DISCOUNT_XEU,
TOT_SURCHARGE_XEU,
LINE_DST_SEQ_NUM,
LINE_DFR_SEQ_NUM,
LINE_UAR_SEQ_NUM,
LAST_NOTE_SEQ_NUM,
ENTRY_TYPE,
ENTRY_REASON,
PC_DISTRIB_STATUS,
PO_REF,
PO_LINE,
BUSINESS_UNIT_CA,
CONTRACT_NUM,
CONTRACT_DT,
CONTRACT_TYPE,
BILL_PLAN_ID,
BPLAN_LN_NBR,
EVENT_OCCURRENCE,
XREF_SEQ_NUM,
CONTRACT_PPD_SEQ,
BUSINESS_UNIT_OM,
ORDER_NO,
ORDER_DATE,
ORDER_INT_LINE_NO,
SCHED_LINE_NBR,
BUSINESS_UNIT_RMA,
RMA_ID,
RMA_LINE_NBR,
PRODUCT_ID,
DIST_CFG_FLAG,
FREIGHT_TERMS,
BILL_OF_LADING,
SHIP_TO_CUST_ID,
SHIP_TO_ADDR_NUM,
SHIP_ID,
SHIP_TYPE_ID,
SHIP_FROM_BU,
SHIP_DATE,
SEQUENCE_NBR,
SOLD_TO_CUST_ID,
SOLD_TO_ADDR_NUM,
BUSINESS_UNIT_PC,
RESOURCE_ID,
PROJECT_ID,
ANALYSIS_TYPE,
RESOURCE_TYPE,
RESOURCE_CATEGORY,
RESOURCE_SUB_CAT,
ACTIVITY_ID,
ACTIVITY_TYPE,
SYSTEM_SOURCE,
EMPLID,
SSN,
EMPL_RCD,
SERVICE_CUST_ID,
SERVICE_ADDR_NUM,
START_DT,
ACCUMULATE,
ERROR_STATUS_BI,
CONTRACT_LINE_NUM,
BUSINESS_UNIT_TO,
IST_TXN_FLG,
IST_DISTRIB_STATUS,
INVENTORY_ITEM,
FISCAL_REGIME,
NATURE_OF_TXN1,
NATURE_OF_TXN2,
IDENTIFIER_TBL,
PACKSLIP_NO,
PPRC_PROMO_CD,
LIST_PRICE,
USER_AMT1,
USER_AMT2,
USER_AMT1_BSE,
USER_AMT2_BSE,
USER_AMT1_XEU,
USER_AMT2_XEU,
USER_DT1,
USER1,
USER2,
USER3,
USER4,
USER5,
USER6,
USER7,
USER8,
USER9,
PROCESS_INSTANCE,
ADD_DTTM,
LAST_UPDATE_DTTM,
LAST_MAINT_OPRID,
ACCRUE_DT,
ASSET_ID,
BI_TAX_TIMING,
BUSINESS_UNIT_AMTO,
BUSINESS_UNIT_RF,
CHARGE_TO_DT,
COST_TYPE,
COUNTRY_LOC_BUYER,
COUNTRY_LOC_SELLER,
COUNTRY_SHIP_FROM,
COUNTRY_SHIP_TO,
COUNTRY_VAT_BILLFR,
COUNTRY_VAT_BILLTO,
COUNTRY_VAT_PERFRM,
COUNTRY_VAT_SUPPLY,
DEFER_DT,
END_DT,
ENTRY_EVENT,
EXD_APPL_FLG,
EXD_ASSESS_VALUE,
EXD_CONVERSION_RT,
EXD_CUST_CATG_CD,
EXD_INVOICE_LINE,
EXD_INVOICE_NO,
EXD_ITM_CATG_CD,
EXD_TAX_AMT,
EXD_TAX_AMT_BSE,
EXD_TAX_AMT_RPT,
EXD_TAX_RATE_CD,
EXD_TAX_RATE_SRC,
EXD_UOM,
EXD_USE_AV_FLG,
EXS_CURRENCY_RPTG,
EXS_DFLTS_APPLIED,
EXS_SERV_TAX_FLG,
EXS_TAX_TXN_TYPE,
FORM_DISTRIB_STAT,
INV_ITEM_ID,
LANG_DESCR_OVR,
MAX_TAX_FLG,
MERCH_TYPE,
ORG_CODE,
ORG_SETID,
ORG_TAX_LOC_CD,
ORIG_QTY,
PHYSICAL_NATURE,
PROFILE_ID,
QTY_BASE,
RT_EFFDT,
SHIP_TIME,
SOURCE_REF_KEY,
SOURCE_REF_NO,
SOURCE_REF_TYPE,
SO_ID,
STATE_LOC_BUYER,
STATE_LOC_SELLER,
STATE_SHIP_FROM,
STATE_SHIP_TO,
STATE_VAT_DEFAULT,
STATE_VAT_PERFRM,
STATE_VAT_SUPPLY,
STX_APPL_FLG,
STX_CUST_CATG_CD,
STX_FORM_CD,
STX_ITM_CATG_CD,
STX_TAX_AMT,
STX_TAX_AMT_BSE,
STX_TAX_AMT_RPT,
STX_TAX_AUTH_CD,
STX_TAX_RATE_CD,
STX_TAX_RATE_SRC,
USER_DT2,
VAT_DFLT_DONE_FLG,
VAT_SERVICE_TYPE,
VAT_SVC_SUPPLY_FLG,
VAT_TREATMENT,
SYSDATE AS ED_CREATE_DATE,
'BI_LINE_PSB_INC.sql' AS ED_CREATE_ID,
'N' AS ED_SOURCE_ARCHIVE_IND,
'Y' AS ARCHIVE_FLAG
from OTR_BI_LINE_PSB
WHERE ADD_DTTM < V_START_DATE 
AND ARCHIVE_FLAG='N';
commit;
END IF;


--Truncating OTR_BI_LINE_PSB
dbo.p_truncate_listed_partition('DBO','OTR_BI_LINE_PSB','PART_NO');

--Making Indexes unusable on dbo.OTR_BI_LINE_PSB
dbo.Pkg_Mass_Load_par_Index_Manip.p_make_tbl_inds_unusable('DBO', 'OTR_BI_LINE_PSB', TRUE, 'PART_NO');


insert /*+ APPEND */ into OTR_BI_LINE_PSB
(BUSINESS_UNIT,
INVOICE,
LINE_SEQ_NUM,
INVOICE_LINE,
ORIGINAL_INVOICE,
ORIGINAL_LINE_SEQ,
NEXT_ADJ_INVOICE,
NEXT_ADJ_LINE_SEQ,
PRIOR_ADJ_INVOICE,
PRIOR_ADJ_LINE_SEQ,
LATEST_INVOICE,
LATEST_LINE_SEQ,
BILL_SOURCE_ID,
SUBCUST_QUAL1,
SUBCUST_QUAL2,
ADJ_LINE_TYPE,
ADJUSTED_FLAG,
LINE_TYPE,
BI_CURRENCY_CD,
BASE_CURRENCY,
CURRENCY_CD_XEU,
CHARGE_FROM_DT,
IDENTIFIER,
DESCR,
UNIT_OF_MEASURE,
QTY,
UNIT_AMT,
PRICE_RECALC_FLG,
TAX_CD,
TAX_EXEMPT_CERT,
TAX_EXEMPT_FLG,
GROSS_EXTENDED_AMT,
NET_EXTENDED_AMT,
ORIG_AMOUNT,
GROSS_EXTENDED_BSE,
NET_EXTENDED_BSE,
GROSS_EXTENDED_XEU,
NET_EXTENDED_XEU,
TAX_AMT,
TAX_AMT_BSE,
TAX_AMT_XEU,
TAX_PCT,
FINAL_TAX_FLG,
VAT_BASIS_AMT,
VAT_BASIS_AMT_BSE,
VAT_BASIS_AMT_XEU,
VAT_AMT,
VAT_AMT_BSE,
VAT_AMT_XEU,
VAT_TRANS_AMT,
VAT_TRANS_AMT_BSE,
VAT_TXN_TYPE_CD,
TAX_CD_VAT,
TAX_CD_VAT_PCT,
VAT_APPLICABILITY,
PROD_GRP_SETID,
VAT_PRODUCT_GROUP,
PRODUCT_KIT_ID,
VAT_DISTRIB_STATUS,
TAX_VAT_FLG,
REV_RECOG_BASIS,
DEFERRED_STATUS,
TOT_LINE_DST_PCT,
TOT_LINE_DFR_PCT,
TOT_LINE_UAR_PCT,
TOT_LINE_DST_AMT,
TOT_LINE_DFR_AMT,
TOT_LINE_UAR_AMT,
TOT_LINE_DST_BSE,
TOT_LINE_DFR_BSE,
TOT_LINE_UAR_BSE,
TOT_LINE_DST_XEU,
TOT_LINE_DFR_XEU,
TOT_LINE_UAR_XEU,
TOT_DISCOUNT_AMT,
TOT_SURCHARGE_AMT,
TOT_DISCOUNT_BSE,
TOT_SURCHARGE_BSE,
TOT_DISCOUNT_XEU,
TOT_SURCHARGE_XEU,
LINE_DST_SEQ_NUM,
LINE_DFR_SEQ_NUM,
LINE_UAR_SEQ_NUM,
LAST_NOTE_SEQ_NUM,
ENTRY_TYPE,
ENTRY_REASON,
PC_DISTRIB_STATUS,
PO_REF,
PO_LINE,
BUSINESS_UNIT_CA,
CONTRACT_NUM,
CONTRACT_DT,
CONTRACT_TYPE,
BILL_PLAN_ID,
BPLAN_LN_NBR,
EVENT_OCCURRENCE,
XREF_SEQ_NUM,
CONTRACT_PPD_SEQ,
BUSINESS_UNIT_OM,
ORDER_NO,
ORDER_DATE,
ORDER_INT_LINE_NO,
SCHED_LINE_NBR,
BUSINESS_UNIT_RMA,
RMA_ID,
RMA_LINE_NBR,
PRODUCT_ID,
DIST_CFG_FLAG,
FREIGHT_TERMS,
BILL_OF_LADING,
SHIP_TO_CUST_ID,
SHIP_TO_ADDR_NUM,
SHIP_ID,
SHIP_TYPE_ID,
SHIP_FROM_BU,
SHIP_DATE,
SEQUENCE_NBR,
SOLD_TO_CUST_ID,
SOLD_TO_ADDR_NUM,
BUSINESS_UNIT_PC,
RESOURCE_ID,
PROJECT_ID,
ANALYSIS_TYPE,
RESOURCE_TYPE,
RESOURCE_CATEGORY,
RESOURCE_SUB_CAT,
ACTIVITY_ID,
ACTIVITY_TYPE,
SYSTEM_SOURCE,
EMPLID,
SSN,
EMPL_RCD,
SERVICE_CUST_ID,
SERVICE_ADDR_NUM,
START_DT,
ACCUMULATE,
ERROR_STATUS_BI,
CONTRACT_LINE_NUM,
BUSINESS_UNIT_TO,
IST_TXN_FLG,
IST_DISTRIB_STATUS,
INVENTORY_ITEM,
FISCAL_REGIME,
NATURE_OF_TXN1,
NATURE_OF_TXN2,
IDENTIFIER_TBL,
PACKSLIP_NO,
PPRC_PROMO_CD,
LIST_PRICE,
USER_AMT1,
USER_AMT2,
USER_AMT1_BSE,
USER_AMT2_BSE,
USER_AMT1_XEU,
USER_AMT2_XEU,
USER_DT1,
USER1,
USER2,
USER3,
USER4,
USER5,
USER6,
USER7,
USER8,
USER9,
PROCESS_INSTANCE,
ADD_DTTM,
LAST_UPDATE_DTTM,
LAST_MAINT_OPRID,
ACCRUE_DT,
ASSET_ID,
BI_TAX_TIMING,
BUSINESS_UNIT_AMTO,
BUSINESS_UNIT_RF,
CHARGE_TO_DT,
COST_TYPE,
COUNTRY_LOC_BUYER,
COUNTRY_LOC_SELLER,
COUNTRY_SHIP_FROM,
COUNTRY_SHIP_TO,
COUNTRY_VAT_BILLFR,
COUNTRY_VAT_BILLTO,
COUNTRY_VAT_PERFRM,
COUNTRY_VAT_SUPPLY,
DEFER_DT,
END_DT,
ENTRY_EVENT,
EXD_APPL_FLG,
EXD_ASSESS_VALUE,
EXD_CONVERSION_RT,
EXD_CUST_CATG_CD,
EXD_INVOICE_LINE,
EXD_INVOICE_NO,
EXD_ITM_CATG_CD,
EXD_TAX_AMT,
EXD_TAX_AMT_BSE,
EXD_TAX_AMT_RPT,
EXD_TAX_RATE_CD,
EXD_TAX_RATE_SRC,
EXD_UOM,
EXD_USE_AV_FLG,
EXS_CURRENCY_RPTG,
EXS_DFLTS_APPLIED,
EXS_SERV_TAX_FLG,
EXS_TAX_TXN_TYPE,
FORM_DISTRIB_STAT,
INV_ITEM_ID,
LANG_DESCR_OVR,
MAX_TAX_FLG,
MERCH_TYPE,
ORG_CODE,
ORG_SETID,
ORG_TAX_LOC_CD,
ORIG_QTY,
PHYSICAL_NATURE,
PROFILE_ID,
QTY_BASE,
RT_EFFDT,
SHIP_TIME,
SOURCE_REF_KEY,
SOURCE_REF_NO,
SOURCE_REF_TYPE,
SO_ID,
STATE_LOC_BUYER,
STATE_LOC_SELLER,
STATE_SHIP_FROM,
STATE_SHIP_TO,
STATE_VAT_DEFAULT,
STATE_VAT_PERFRM,
STATE_VAT_SUPPLY,
STX_APPL_FLG,
STX_CUST_CATG_CD,
STX_FORM_CD,
STX_ITM_CATG_CD,
STX_TAX_AMT,
STX_TAX_AMT_BSE,
STX_TAX_AMT_RPT,
STX_TAX_AUTH_CD,
STX_TAX_RATE_CD,
STX_TAX_RATE_SRC,
USER_DT2,
VAT_DFLT_DONE_FLG,
VAT_SERVICE_TYPE,
VAT_SVC_SUPPLY_FLG,
VAT_TREATMENT,
ED_CREATE_DATE,
ED_CREATE_ID,
ED_SOURCE_ARCHIVE_IND,
ARCHIVE_FLAG
)
SELECT
BUSINESS_UNIT,
INVOICE,
LINE_SEQ_NUM,
INVOICE_LINE,
ORIGINAL_INVOICE,
ORIGINAL_LINE_SEQ,
NEXT_ADJ_INVOICE,
NEXT_ADJ_LINE_SEQ,
PRIOR_ADJ_INVOICE,
PRIOR_ADJ_LINE_SEQ,
LATEST_INVOICE,
LATEST_LINE_SEQ,
BILL_SOURCE_ID,
SUBCUST_QUAL1,
SUBCUST_QUAL2,
ADJ_LINE_TYPE,
ADJUSTED_FLAG,
LINE_TYPE,
BI_CURRENCY_CD,
BASE_CURRENCY,
CURRENCY_CD_XEU,
CHARGE_FROM_DT,
IDENTIFIER,
DESCR,
UNIT_OF_MEASURE,
QTY,
UNIT_AMT,
PRICE_RECALC_FLG,
TAX_CD,
TAX_EXEMPT_CERT,
TAX_EXEMPT_FLG,
GROSS_EXTENDED_AMT,
NET_EXTENDED_AMT,
ORIG_AMOUNT,
GROSS_EXTENDED_BSE,
NET_EXTENDED_BSE,
GROSS_EXTENDED_XEU,
NET_EXTENDED_XEU,
TAX_AMT,
TAX_AMT_BSE,
TAX_AMT_XEU,
TAX_PCT,
FINAL_TAX_FLG,
VAT_BASIS_AMT,
VAT_BASIS_AMT_BSE,
VAT_BASIS_AMT_XEU,
VAT_AMT,
VAT_AMT_BSE,
VAT_AMT_XEU,
VAT_TRANS_AMT,
VAT_TRANS_AMT_BSE,
VAT_TXN_TYPE_CD,
TAX_CD_VAT,
TAX_CD_VAT_PCT,
VAT_APPLICABILITY,
PROD_GRP_SETID,
VAT_PRODUCT_GROUP,
PRODUCT_KIT_ID,
VAT_DISTRIB_STATUS,
TAX_VAT_FLG,
REV_RECOG_BASIS,
DEFERRED_STATUS,
TOT_LINE_DST_PCT,
TOT_LINE_DFR_PCT,
TOT_LINE_UAR_PCT,
TOT_LINE_DST_AMT,
TOT_LINE_DFR_AMT,
TOT_LINE_UAR_AMT,
TOT_LINE_DST_BSE,
TOT_LINE_DFR_BSE,
TOT_LINE_UAR_BSE,
TOT_LINE_DST_XEU,
TOT_LINE_DFR_XEU,
TOT_LINE_UAR_XEU,
TOT_DISCOUNT_AMT,
TOT_SURCHARGE_AMT,
TOT_DISCOUNT_BSE,
TOT_SURCHARGE_BSE,
TOT_DISCOUNT_XEU,
TOT_SURCHARGE_XEU,
LINE_DST_SEQ_NUM,
LINE_DFR_SEQ_NUM,
LINE_UAR_SEQ_NUM,
LAST_NOTE_SEQ_NUM,
ENTRY_TYPE,
ENTRY_REASON,
PC_DISTRIB_STATUS,
PO_REF,
PO_LINE,
BUSINESS_UNIT_CA,
CONTRACT_NUM,
CONTRACT_DT,
CONTRACT_TYPE,
BILL_PLAN_ID,
BPLAN_LN_NBR,
EVENT_OCCURRENCE,
XREF_SEQ_NUM,
CONTRACT_PPD_SEQ,
BUSINESS_UNIT_OM,
ORDER_NO,
ORDER_DATE,
ORDER_INT_LINE_NO,
SCHED_LINE_NBR,
BUSINESS_UNIT_RMA,
RMA_ID,
RMA_LINE_NBR,
PRODUCT_ID,
DIST_CFG_FLAG,
FREIGHT_TERMS,
BILL_OF_LADING,
SHIP_TO_CUST_ID,
SHIP_TO_ADDR_NUM,
SHIP_ID,
SHIP_TYPE_ID,
SHIP_FROM_BU,
SHIP_DATE,
SEQUENCE_NBR,
SOLD_TO_CUST_ID,
SOLD_TO_ADDR_NUM,
BUSINESS_UNIT_PC,
RESOURCE_ID,
PROJECT_ID,
ANALYSIS_TYPE,
RESOURCE_TYPE,
RESOURCE_CATEGORY,
RESOURCE_SUB_CAT,
ACTIVITY_ID,
ACTIVITY_TYPE,
SYSTEM_SOURCE,
EMPLID,
SSN,
EMPL_RCD,
SERVICE_CUST_ID,
SERVICE_ADDR_NUM,
START_DT,
ACCUMULATE,
ERROR_STATUS_BI,
CONTRACT_LINE_NUM,
BUSINESS_UNIT_TO,
IST_TXN_FLG,
IST_DISTRIB_STATUS,
INVENTORY_ITEM,
FISCAL_REGIME,
NATURE_OF_TXN1,
NATURE_OF_TXN2,
IDENTIFIER_TBL,
PACKSLIP_NO,
PPRC_PROMO_CD,
LIST_PRICE,
USER_AMT1,
USER_AMT2,
USER_AMT1_BSE,
USER_AMT2_BSE,
USER_AMT1_XEU,
USER_AMT2_XEU,
USER_DT1,
USER1,
USER2,
USER3,
USER4,
USER5,
USER6,
USER7,
USER8,
USER9,
PROCESS_INSTANCE,
ADD_DTTM,
LAST_UPDATE_DTTM,
LAST_MAINT_OPRID,
ACCRUE_DT,
ASSET_ID,
BI_TAX_TIMING,
BUSINESS_UNIT_AMTO,
BUSINESS_UNIT_RF,
CHARGE_TO_DT,
COST_TYPE,
COUNTRY_LOC_BUYER,
COUNTRY_LOC_SELLER,
COUNTRY_SHIP_FROM,
COUNTRY_SHIP_TO,
COUNTRY_VAT_BILLFR,
COUNTRY_VAT_BILLTO,
COUNTRY_VAT_PERFRM,
COUNTRY_VAT_SUPPLY,
DEFER_DT,
END_DT,
ENTRY_EVENT,
EXD_APPL_FLG,
EXD_ASSESS_VALUE,
EXD_CONVERSION_RT,
EXD_CUST_CATG_CD,
EXD_INVOICE_LINE,
EXD_INVOICE_NO,
EXD_ITM_CATG_CD,
EXD_TAX_AMT,
EXD_TAX_AMT_BSE,
EXD_TAX_AMT_RPT,
EXD_TAX_RATE_CD,
EXD_TAX_RATE_SRC,
EXD_UOM,
EXD_USE_AV_FLG,
EXS_CURRENCY_RPTG,
EXS_DFLTS_APPLIED,
EXS_SERV_TAX_FLG,
EXS_TAX_TXN_TYPE,
FORM_DISTRIB_STAT,
INV_ITEM_ID,
LANG_DESCR_OVR,
MAX_TAX_FLG,
MERCH_TYPE,
ORG_CODE,
ORG_SETID,
ORG_TAX_LOC_CD,
ORIG_QTY,
PHYSICAL_NATURE,
PROFILE_ID,
QTY_BASE,
RT_EFFDT,
SHIP_TIME,
SOURCE_REF_KEY,
SOURCE_REF_NO,
SOURCE_REF_TYPE,
SO_ID,
STATE_LOC_BUYER,
STATE_LOC_SELLER,
STATE_SHIP_FROM,
STATE_SHIP_TO,
STATE_VAT_DEFAULT,
STATE_VAT_PERFRM,
STATE_VAT_SUPPLY,
STX_APPL_FLG,
STX_CUST_CATG_CD,
STX_FORM_CD,
STX_ITM_CATG_CD,
STX_TAX_AMT,
STX_TAX_AMT_BSE,
STX_TAX_AMT_RPT,
STX_TAX_AUTH_CD,
STX_TAX_RATE_CD,
STX_TAX_RATE_SRC,
USER_DT2,
VAT_DFLT_DONE_FLG,
VAT_SERVICE_TYPE,
VAT_SVC_SUPPLY_FLG,
VAT_TREATMENT,
SYSDATE AS ED_CREATE_DATE,
'BI_LINE_PSB_INC.sql' as ED_CREATE_ID,
'N' as ED_SOURCE_ARCHIVE_IND,
'N' as ARCHIVE_FLAG
FROM PS_BI_LINE where ADD_DTTM >=V_START_DATE;

COMMIT;


-- Rebuilding Indexes on dbo.OTR_BI_LINE_PSB
dbo.Pkg_Mass_Load_par_Index_Manip.p_rebuild_tbl_inds('DBO', 'OTR_BI_LINE_PSB', FALSE, 'PART_NO');
END;
/

prompt Updating OTR_LOAD_CONTROL
Declare
    count1 number :=0;
    tablename varchar2(30) := 'OTR_BI_LINE_PSB';
    comment_prod varchar2(400) := 'BEFORE6; Incremental Truncates NO Archive partition and loads current year and two previous years only.';
    comment_test varchar2(400) := 'BEFORE6; Not in production yet.';

BEGIN
    SELECT count(*) into count1
    FROM OTR_LOAD_CONTROL olc
    WHERE olc.TABLE_NAME=tablename;

    If count1=0 then
    INSERT into OTR_LOAD_CONTROL
      VALUES(tablename, sysdate, comment_test);
    end if;
    
  IF '&production_variable' = 'Y' then
    UPDATE OTR_LOAD_CONTROL olc 
    SET LOAD_COMMENT=comment_prod,
        LAST_LOAD_DATE=sysdate 
    WHERE olc.TABLE_NAME=tablename;
  ELSIF '&production_variable' = 'N' THEN
    UPDATE OTR_LOAD_CONTROL olc 
    SET LOAD_COMMENT=comment_test,
        LAST_LOAD_DATE=sysdate 
    WHERE olc.TABLE_NAME=tablename;
  ELSE /* Do not change load_comment */
    UPDATE OTR_LOAD_CONTROL olc 
    SET LAST_LOAD_DATE=sysdate
    WHERE olc.TABLE_NAME=tablename;
  END if;

    COMMIT;
    
END;
/

EXIT
